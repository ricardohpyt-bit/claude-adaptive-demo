<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Constitutional Design for UI - Claude Adaptive Demo</title>
  <meta name="description" content="An interactive prototype demonstrating how Claude could adapt its interface based on user learning styles.">
  <meta name="color-scheme" content="light dark">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f5f5f5; }
    @media (prefers-color-scheme: dark) { body { background: #1a1a1a; } }
    #root { width: 100%; height: 100vh; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    @keyframes spotlight-ring { 0%, 100% { box-shadow: 0 0 0 3px rgba(217, 119, 87, 0.6), 0 0 0 6px rgba(217, 119, 87, 0.3), 0 0 20px rgba(217, 119, 87, 0.4); } 50% { box-shadow: 0 0 0 4px rgba(217, 119, 87, 0.8), 0 0 0 8px rgba(217, 119, 87, 0.4), 0 0 30px rgba(217, 119, 87, 0.5); } }
    .loading { display: flex; align-items: center; justify-content: center; height: 100vh; font-size: 18px; color: #666; }
  </style>
</head>
<body>
  <div id="root"><div class="loading">Loading demo...</div></div>
  
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  
  <script>
    function initApp() {
      if (typeof React === 'undefined' || typeof ReactDOM === 'undefined') {
        setTimeout(initApp, 100);
        return;
      }
      
      const e = React.createElement;
      const useState = React.useState;
      const useEffect = React.useEffect;
      const useRef = React.useRef;

      // Detect system dark mode (works in iframes too)
      function useSystemDarkMode() {
        var getPrefersDark = function() {
          // Check URL parameter first (for testing)
          var params = new URLSearchParams(window.location.search);
          if (params.get('theme') === 'dark') return true;
          if (params.get('theme') === 'light') return false;
          // Check if parent page has set a data attribute
          if (document.documentElement.getAttribute('data-theme') === 'dark') return true;
          if (document.documentElement.getAttribute('data-theme') === 'light') return false;
          // Check CSS media query
          if (window.matchMedia) {
            return window.matchMedia('(prefers-color-scheme: dark)').matches;
          }
          return false;
        };
        
        var [isDark, setIsDark] = useState(getPrefersDark);
        
        useEffect(function() {
          if (!window.matchMedia) return;
          
          var mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
          var handler = function(e) { setIsDark(e.matches); };
          mediaQuery.addEventListener('change', handler);
          
          // Also observe data-theme attribute changes
          var observer = new MutationObserver(function() {
            var theme = document.documentElement.getAttribute('data-theme');
            if (theme === 'dark') setIsDark(true);
            else if (theme === 'light') setIsDark(false);
          });
          observer.observe(document.documentElement, { attributes: true, attributeFilter: ['data-theme'] });
          
          return function() {
            mediaQuery.removeEventListener('change', handler);
            observer.disconnect();
          };
        }, []);
        
        return isDark;
      }

      // Color themes
      function getColors(isDark) {
        if (isDark) {
          return {
            bgPrimary: '#1a1915', bgSidebar: '#141310', textPrimary: '#FAF9F7',
            textSecondary: '#9B9690', textMuted: '#6B6760', accent: '#D97757',
            borderLight: '#2a2824', borderMedium: '#3a3830', userBubble: '#2a2824',
            blue: '#60A5FA', purple: '#A78BFA', green: '#4ADE80',
            cardBg: '#1f1e1a', overlayBg: 'rgba(0,0,0,0.85)'
          };
        }
        return {
          bgPrimary: '#FAF9F7', bgSidebar: '#F5F4F0', textPrimary: '#1A1915',
          textSecondary: '#6B6760', textMuted: '#9B9690', accent: '#D97757',
          borderLight: '#E8E6E1', borderMedium: '#D4D2CD', userBubble: '#F0EFEB',
          blue: '#3B82F6', purple: '#8B5CF6', green: '#22C55E',
          cardBg: '#ffffff', overlayBg: 'rgba(0,0,0,0.7)'
        };
      }

      // Icons
      function getIcons(colors) {
        return {
          Claude: function(props) { 
            var size = props.size || 20;
            return e('svg', {width: size, height: size, viewBox: '0 0 24 24', fill: 'none'},
              e('path', {d: 'M12 2L13.09 8.26L18 6L14.74 10.91L21 12L14.74 13.09L18 18L13.09 15.74L12 22L10.91 15.74L6 18L9.26 13.09L3 12L9.26 10.91L6 6L10.91 8.26L12 2Z', fill: colors.accent})
            );
          },
          Send: function(props) {
            var size = props.size || 16;
            var color = props.color || '#fff';
            return e('svg', {width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: color, strokeWidth: 2},
              e('line', {x1: 22, y1: 2, x2: 11, y2: 13}), e('polygon', {points: '22 2 15 22 11 13 2 9 22 2'})
            );
          },
          Plus: function(props) {
            var size = props.size || 15;
            return e('svg', {width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2},
              e('line', {x1: 12, y1: 5, x2: 12, y2: 19}), e('line', {x1: 5, y1: 12, x2: 19, y2: 12})
            );
          },
          Zap: function(props) {
            var size = props.size || 16;
            var color = props.color;
            return e('svg', {width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: color, strokeWidth: 2},
              e('polygon', {points: '13 2 3 14 12 14 11 22 21 10 12 10 13 2'})
            );
          },
          Layers: function(props) {
            var size = props.size || 12;
            return e('svg', {width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2},
              e('polygon', {points: '12 2 2 7 12 12 22 7 12 2'}), e('polyline', {points: '2 17 12 22 22 17'}), e('polyline', {points: '2 12 12 17 22 12'})
            );
          },
          Info: function(props) {
            var size = props.size || 12;
            return e('svg', {width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2},
              e('circle', {cx: 12, cy: 12, r: 10}), e('line', {x1: 12, y1: 16, x2: 12, y2: 12}), e('line', {x1: 12, y1: 8, x2: 12.01, y2: 8})
            );
          },
          ChevronRight: function(props) {
            var size = props.size || 12;
            return e('svg', {width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2},
              e('polyline', {points: '9 18 15 12 9 6'})
            );
          },
          ChevronDown: function(props) {
            var size = props.size || 12;
            return e('svg', {width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2},
              e('polyline', {points: '6 9 12 15 18 9'})
            );
          },
          Lightbulb: function(props) {
            var size = props.size || 18;
            return e('svg', {width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2},
              e('path', {d: 'M9 18h6'}), e('path', {d: 'M10 22h4'}), e('path', {d: 'M12 2a7 7 0 0 0-4 12.7V17h8v-2.3A7 7 0 0 0 12 2z'})
            );
          },
          ArrowRight: function(props) {
            var size = props.size || 10;
            return e('svg', {width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2},
              e('line', {x1: 5, y1: 12, x2: 19, y2: 12}), e('polyline', {points: '12 5 19 12 12 19'})
            );
          },
          Compass: function(props) {
            var size = props.size || 10;
            return e('svg', {width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2},
              e('circle', {cx: 12, cy: 12, r: 10}), e('polygon', {points: '16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76'})
            );
          },
          ArrowUpRight: function(props) {
            var size = props.size || 10;
            return e('svg', {width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2},
              e('line', {x1: 7, y1: 17, x2: 17, y2: 7}), e('polyline', {points: '7 7 17 7 17 17'})
            );
          },
          Image: function(props) {
            var size = props.size || 10;
            return e('svg', {width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2},
              e('rect', {x: 3, y: 3, width: 18, height: 18, rx: 2}), e('circle', {cx: 8.5, cy: 8.5, r: 1.5}), e('polyline', {points: '21 15 16 10 5 21'})
            );
          },
          FileText: function(props) {
            var size = props.size || 10;
            return e('svg', {width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2},
              e('path', {d: 'M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z'}), e('polyline', {points: '14 2 14 8 20 8'}), e('line', {x1: 16, y1: 13, x2: 8, y2: 13}), e('line', {x1: 16, y1: 17, x2: 8, y2: 17})
            );
          },
          Code: function(props) {
            var size = props.size || 10;
            return e('svg', {width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2},
              e('polyline', {points: '16 18 22 12 16 6'}), e('polyline', {points: '8 6 2 12 8 18'})
            );
          },
          X: function(props) {
            var size = props.size || 14;
            return e('svg', {width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2},
              e('line', {x1: 18, y1: 6, x2: 6, y2: 18}), e('line', {x1: 6, y1: 6, x2: 18, y2: 18})
            );
          },
          Trophy: function(props) {
            var size = props.size || 28;
            var color = props.color || '#fff';
            return e('svg', {width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: color, strokeWidth: 2},
              e('path', {d: 'M6 9H4.5a2.5 2.5 0 0 1 0-5H6'}), e('path', {d: 'M18 9h1.5a2.5 2.5 0 0 0 0-5H18'}), e('path', {d: 'M4 22h16'}), e('path', {d: 'M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22'}), e('path', {d: 'M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22'}), e('path', {d: 'M18 2H6v7a6 6 0 0 0 12 0V2Z'})
            );
          },
          RotateCcw: function(props) {
            var size = props.size || 12;
            return e('svg', {width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2},
              e('path', {d: 'M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8'}), e('path', {d: 'M3 3v5h5'})
            );
          },
          Play: function(props) {
            var size = props.size || 16;
            return e('svg', {width: size, height: size, viewBox: '0 0 24 24', fill: 'currentColor'},
              e('polygon', {points: '5 3 19 12 5 21 5 3'})
            );
          },
          HelpCircle: function(props) {
            var size = props.size || 16;
            return e('svg', {width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2},
              e('circle', {cx: 12, cy: 12, r: 10}), e('path', {d: 'M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3'}), e('line', {x1: 12, y1: 17, x2: 12.01, y2: 17})
            );
          },
          MessageBubble: function() {
            return e('svg', {width: 18, height: 18, viewBox: '0 0 24 24', fill: 'none', stroke: 'white', strokeWidth: 2},
              e('path', {d: 'M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z'})
            );
          },
          TextSplit: function() {
            return e('svg', {width: 18, height: 18, viewBox: '0 0 24 24', fill: 'none', stroke: 'white', strokeWidth: 2},
              e('path', {d: 'M4 7V4h16v3'}), e('path', {d: 'M9 20h6'}), e('path', {d: 'M12 4v16'})
            );
          },
          Network: function() {
            return e('svg', {width: 18, height: 18, viewBox: '0 0 24 24', fill: 'none', stroke: 'white', strokeWidth: 2},
              e('circle', {cx: 12, cy: 12, r: 3}), e('circle', {cx: 19, cy: 5, r: 2}), e('circle', {cx: 5, cy: 5, r: 2}), e('circle', {cx: 19, cy: 19, r: 2}), e('circle', {cx: 5, cy: 19, r: 2}),
              e('line', {x1: 12, y1: 9, x2: 12, y2: 5}), e('line', {x1: 14.5, y1: 13.5, x2: 17, y2: 17}), e('line', {x1: 9.5, y1: 13.5, x2: 7, y2: 17})
            );
          },
          Grid: function() {
            return e('svg', {width: 18, height: 18, viewBox: '0 0 24 24', fill: 'none', stroke: 'white', strokeWidth: 2},
              e('rect', {x: 3, y: 3, width: 18, height: 18, rx: 2}), e('path', {d: 'M3 9h18'}), e('path', {d: 'M3 15h18'}), e('path', {d: 'M9 3v18'}), e('path', {d: 'M15 3v18'})
            );
          },
          Chart: function() {
            return e('svg', {width: 18, height: 18, viewBox: '0 0 24 24', fill: 'none', stroke: 'white', strokeWidth: 2},
              e('polyline', {points: '22 7 13.5 15.5 8.5 10.5 2 17'}), e('polyline', {points: '16 7 22 7 22 13'})
            );
          }
        };
      }

      // SPOTLIGHT TOUR COMPONENT
      function SpotlightTour(props) {
        var step = props.step;
        var onNext = props.onNext;
        var onSkip = props.onSkip;
        var onComplete = props.onComplete;
        var colors = props.colors;
        var Icons = props.Icons;
        var isLoading = props.isLoading;
        
        var [spotlightPos, setSpotlightPos] = useState(null);
        
        var steps = [
          {
            title: 'Welcome to Constitutional Design',
            description: 'This prototype shows how Claude could adapt its entire interface based on who you areâ€”not just what you ask.',
            target: null,
            tooltipPos: 'center'
          },
          {
            title: 'Switch Personas',
            description: 'Try switching between Maya (visual), James (reader), and Alex (hands-on) to see how the same question generates completely different responses.',
            target: '[data-tour="persona-switcher"]',
            tooltipPos: 'right'
          },
          {
            title: 'Feasibility Layers',
            description: 'Toggle "Show feasibility" to see what\'s buildable today vs. future vision. Hover the badges for implementation details.',
            target: '[data-tour="feasibility-toggle"]',
            tooltipPos: 'right'
          },
          {
            title: 'See the Rules in Action',
            description: 'Click "Why this format?" to reveal the Constitutional Design rulesâ€”the memory and logic that shaped this response.',
            target: '[data-tour="why-format"]',
            tooltipPos: 'bottom',
            requiresChat: true
          },
          {
            title: 'User Agency',
            description: "Users can override Claude's auto-selected format. The AI suggests, but you decide.",
            target: '[data-tour="format-switcher"]',
            tooltipPos: 'bottom',
            requiresChat: true
          },
          {
            title: "You're Ready!",
            description: 'Explore the demo. Switch personas, click around, and see Constitutional Design in action.',
            target: null,
            tooltipPos: 'center'
          }
        ];
        
        var currentStep = steps[step];
        var isLast = step === steps.length - 1;
        var waitingForChat = isLoading && currentStep.requiresChat;
        
        // Update spotlight position when step changes (with retry for async elements)
        useEffect(function() {
          if (waitingForChat) {
            setSpotlightPos(null);
            return;
          }
          
          var attempts = 0;
          var maxAttempts = 20;
          var timeoutId;
          
          function tryFindElement() {
            if (currentStep.target) {
              var el = document.querySelector(currentStep.target);
              if (el) {
                var rect = el.getBoundingClientRect();
                setSpotlightPos({
                  top: rect.top - 8,
                  left: rect.left - 8,
                  width: rect.width + 16,
                  height: rect.height + 16
                });
              } else if (attempts < maxAttempts) {
                attempts++;
                timeoutId = setTimeout(tryFindElement, 150);
              } else {
                setSpotlightPos(null);
              }
            } else {
              setSpotlightPos(null);
            }
          }
          
          tryFindElement();
          
          return function() {
            if (timeoutId) clearTimeout(timeoutId);
          };
        }, [step, isLoading]);
        
        // Calculate tooltip position
        var tooltipStyle = {
          position: 'fixed',
          zIndex: 10002,
          backgroundColor: colors.cardBg,
          color: colors.textPrimary,
          padding: '24px',
          borderRadius: 16,
          maxWidth: 340,
          boxShadow: '0 8px 32px rgba(0,0,0,0.3)',
          border: '1px solid ' + colors.borderLight,
          transition: 'all 0.3s ease'
        };
        
        // Center tooltip when waiting for chat or no spotlight
        if (currentStep.tooltipPos === 'center' || waitingForChat || !spotlightPos) {
          tooltipStyle.top = '50%';
          tooltipStyle.left = '50%';
          tooltipStyle.transform = 'translate(-50%, -50%)';
        } else if (currentStep.tooltipPos === 'right' && spotlightPos) {
          tooltipStyle.top = spotlightPos.top + 'px';
          tooltipStyle.left = (spotlightPos.left + spotlightPos.width + 20) + 'px';
          tooltipStyle.transform = 'none';
        } else if (currentStep.tooltipPos === 'bottom' && spotlightPos) {
          tooltipStyle.top = (spotlightPos.top + spotlightPos.height + 20) + 'px';
          tooltipStyle.left = spotlightPos.left + 'px';
          tooltipStyle.transform = 'none';
        }
        
        return e('div', null,
          // Dark overlay with cutout
          e('div', {style: {position: 'fixed', inset: 0, zIndex: 9999, pointerEvents: 'none', transition: 'all 0.3s ease'}},
            e('svg', {width: '100%', height: '100%', style: {position: 'absolute', inset: 0}},
              e('defs', null,
                e('mask', {id: 'spotlight-mask'},
                  e('rect', {x: 0, y: 0, width: '100%', height: '100%', fill: 'white'}),
                  spotlightPos && !waitingForChat && e('rect', {
                    x: spotlightPos.left,
                    y: spotlightPos.top,
                    width: spotlightPos.width,
                    height: spotlightPos.height,
                    rx: 12,
                    fill: 'black'
                  })
                )
              ),
              e('rect', {
                x: 0, y: 0, width: '100%', height: '100%',
                fill: colors.overlayBg,
                mask: 'url(#spotlight-mask)'
              })
            )
          ),
          
          // Spotlight ring animation
          spotlightPos && !waitingForChat && e('div', {
            style: {
              position: 'fixed',
              top: spotlightPos.top,
              left: spotlightPos.left,
              width: spotlightPos.width,
              height: spotlightPos.height,
              borderRadius: 12,
              animation: 'spotlight-ring 2s ease-in-out infinite',
              zIndex: 10000,
              pointerEvents: 'none'
            }
          }),
          
          // Click blocker (prevents interaction with app during tour)
          e('div', {
            style: {position: 'fixed', inset: 0, zIndex: 10001}
          }),
          
          // Tooltip
          e('div', {
            onClick: function(ev) { ev.stopPropagation(); },
            style: tooltipStyle
          },
            // Step indicator
            e('div', {style: {display: 'flex', gap: 6, marginBottom: 16}},
              steps.map(function(_, i) {
                return e('div', {key: i, style: {
                  width: i === step ? 24 : 8,
                  height: 8,
                  borderRadius: 4,
                  backgroundColor: i === step ? colors.accent : colors.borderMedium,
                  transition: 'all 0.3s'
                }});
              })
            ),
            
            // Content
            waitingForChat ? e('div', {style: {textAlign: 'center', padding: '20px 0'}},
              e('div', {style: {width: 40, height: 40, borderRadius: '50%', backgroundColor: colors.accent + '20', display: 'flex', alignItems: 'center', justifyContent: 'center', margin: '0 auto 16px'}},
                e(Icons.Claude, {size: 20})
              ),
              e('h3', {style: {margin: '0 0 8px', fontSize: 18, fontWeight: 600, color: colors.textPrimary}}, 'Claude is thinking...'),
              e('p', {style: {margin: 0, fontSize: 14, color: colors.textSecondary}}, 'Watch how the response adapts to the persona.')
            ) : e(React.Fragment, null,
              e('h3', {style: {margin: '0 0 8px', fontSize: 20, fontWeight: 600, color: colors.textPrimary}}, currentStep.title),
              e('p', {style: {margin: '0 0 24px', fontSize: 15, lineHeight: 1.6, color: colors.textSecondary}}, currentStep.description)
            ),
            
            // Buttons (hide next during loading)
            e('div', {style: {display: 'flex', justifyContent: 'space-between', alignItems: 'center'}},
              e('button', {
                onClick: onSkip,
                style: {background: 'none', border: 'none', color: colors.textMuted, fontSize: 14, cursor: 'pointer', padding: '8px 0', fontFamily: 'inherit'}
              }, 'Skip tour'),
              !waitingForChat && e('button', {
                onClick: isLast ? onComplete : onNext,
                style: {display: 'flex', alignItems: 'center', gap: 8, padding: '12px 24px', backgroundColor: colors.accent, color: '#fff', border: 'none', borderRadius: 10, fontSize: 15, fontWeight: 500, cursor: 'pointer', fontFamily: 'inherit'}
              }, isLast ? 'Start Exploring' : 'Next', !isLast && e(Icons.ArrowRight, {size: 16}))
            )
          )
        );
      }

      // TOUR TRIGGER BUTTON (for sidebar)
      function TourButton(props) {
        var onClick = props.onClick;
        var colors = props.colors;
        var Icons = props.Icons;
        
        return e('button', {
          onClick: onClick,
          style: {
            width: '100%',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            gap: 8,
            padding: '10px 14px',
            backgroundColor: colors.accent,
            color: '#fff',
            border: 'none',
            borderRadius: 8,
            fontSize: 13,
            fontWeight: 600,
            cursor: 'pointer',
            fontFamily: 'inherit'
          }
        }, e(Icons.HelpCircle, {size: 16}), 'Take the Tour');
      }

      function FeasibilityBadge(props) {
        var level = props.level;
        var glow = props.glow !== false;
        var colors = props.colors;
        
        var _s = useState(false);
        var showTip = _s[0];
        var setShowTip = _s[1];
        
        var configs = {
          now: { label: 'Buildable now', color: colors.green, tooltip: "Can be implemented today using Claude's existing memory system and system prompts." },
          near: { label: 'Near-term', color: colors.blue, tooltip: 'Achievable with current artifact capabilities plus some UI/frontend work.' },
          future: { label: 'Future vision', color: colors.purple, tooltip: 'Requires new client-side infrastructure and deeper platform integration.' }
        };
        var c = configs[level];
        
        return e('span', {
          style: {position: 'relative', display: 'inline-flex', zIndex: 100},
          onMouseEnter: function() { setShowTip(true); },
          onMouseLeave: function() { setShowTip(false); }
        },
          e('span', {style: {fontSize: 9, fontWeight: 600, padding: '3px 7px', borderRadius: 4, backgroundColor: colors.cardBg, color: c.color, textTransform: 'uppercase', letterSpacing: '0.3px', cursor: 'help', border: '2px solid ' + c.color, boxShadow: glow ? '0 0 12px ' + c.color + '60' : 'none'}}, c.label),
          showTip && e('span', {style: {position: 'absolute', bottom: '100%', left: '50%', transform: 'translateX(-50%)', marginBottom: 8, padding: '10px 12px', backgroundColor: '#1a1a1a', color: '#fff', fontSize: 11, lineHeight: 1.5, borderRadius: 8, width: 200, textAlign: 'left', zIndex: 1000, boxShadow: '0 4px 12px rgba(0,0,0,0.3)'}},
            e('span', {style: {fontWeight: 600, color: c.color, display: 'block', marginBottom: 4}}, c.label), c.tooltip
          )
        );
      }

      function Beacons(props) {
        var drillDown = props.drillDown || [];
        var sideways = props.sideways || [];
        var broaden = props.broaden || [];
        var onSelect = props.onSelect;
        var colors = props.colors;
        var Icons = props.Icons;
        
        var items = [].concat(
          drillDown.map(function(t) { return {text: t, color: colors.blue, icon: e(Icons.ArrowRight, {size: 10})}; }),
          sideways.map(function(t) { return {text: t, color: colors.purple, icon: e(Icons.Compass, {size: 10})}; }),
          broaden.map(function(t) { return {text: t, color: colors.green, icon: e(Icons.ArrowUpRight, {size: 10})}; })
        );
        
        if (!items.length) return null;
        
        return e('div', {style: {marginTop: 16, padding: 14, backgroundColor: colors.bgSidebar, borderRadius: 12, border: '1px solid ' + colors.borderLight}},
          e('div', {style: {fontSize: 11, fontWeight: 600, color: colors.textMuted, textTransform: 'uppercase', letterSpacing: 0.5, marginBottom: 10}}, 'Continue exploring'),
          e('div', {style: {display: 'flex', gap: 8, flexWrap: 'wrap'}},
            items.map(function(item, i) {
              return e('button', {
                key: i,
                onClick: function() { onSelect(item.text); },
                style: {display: 'flex', alignItems: 'center', gap: 5, padding: '6px 12px', backgroundColor: colors.cardBg, border: '1px solid ' + item.color + '40', borderRadius: 20, cursor: 'pointer', fontSize: 12, color: colors.textPrimary, fontFamily: 'inherit'}
              }, e('span', {style: {color: item.color}}, item.icon), item.text);
            })
          )
        );
      }

      function WelcomeScreen(props) {
        var onSelectPrompt = props.onSelectPrompt;
        var persona = props.persona;
        var colors = props.colors;
        var Icons = props.Icons;
        
        var names = {maya: 'Maya', james: 'James', alex: 'Alex'};
        var greetings = {maya: 'Ready to visualize something?', james: 'Ready to explore ideas in depth?', alex: 'Ready to build something?'};
        
        return e('div', {style: {display: 'flex', flexDirection: 'column', alignItems: 'center', padding: 32}},
          e(Icons.Claude, {size: 48}),
          e('h1', {style: {fontSize: 28, fontWeight: 600, color: colors.textPrimary, marginTop: 16, marginBottom: 8}}, 'Good afternoon, ' + names[persona]),
          e('p', {style: {fontSize: 16, color: colors.textSecondary, maxWidth: 400, textAlign: 'center', marginBottom: 32}}, greetings[persona]),
          e('button', {
            onClick: function() { onSelectPrompt('Explain how large language models work'); },
            style: {display: 'flex', alignItems: 'center', gap: 12, padding: 16, backgroundColor: colors.cardBg, border: '1px solid ' + colors.borderLight, borderRadius: 12, cursor: 'pointer', textAlign: 'left', fontFamily: 'inherit', maxWidth: 300}
          },
            e('div', {style: {color: colors.accent}}, e(Icons.Lightbulb, {size: 18})),
            e('div', null,
              e('div', {style: {fontSize: 10, fontWeight: 600, color: colors.textMuted, textTransform: 'uppercase'}}, 'Learn'),
              e('div', {style: {fontSize: 14, color: colors.textPrimary, marginTop: 4}}, 'Explain how large language models work')
            )
          )
        );
      }

      function InputBar(props) {
        var persona = props.persona;
        var onSend = props.onSend;
        var value = props.value;
        var setValue = props.setValue;
        var colors = props.colors;
        var Icons = props.Icons;
        
        var placeholders = {maya: 'Describe what you want to visualize...', james: 'What would you like to explore?', alex: 'What do you want to build?'};
        
        return e('div', {style: {padding: '12px 24px 16px', borderTop: '1px solid ' + colors.borderLight, backgroundColor: colors.bgPrimary}},
          e('div', {style: {display: 'flex', alignItems: 'center', gap: 12, backgroundColor: colors.cardBg, border: '1px solid ' + colors.borderMedium, borderRadius: 24, padding: '8px 8px 8px 20px'}},
            e('input', {
              type: 'text',
              value: value,
              onChange: function(ev) { setValue(ev.target.value); },
              placeholder: placeholders[persona],
              style: {flex: 1, border: 'none', outline: 'none', fontSize: 15, color: colors.textPrimary, backgroundColor: 'transparent', fontFamily: 'inherit'},
              onKeyDown: function(ev) { if (ev.key === 'Enter' && value.trim()) onSend(value); }
            }),
            e('button', {
              onClick: function() { if (value.trim()) onSend(value); },
              style: {width: 36, height: 36, borderRadius: '50%', border: 'none', backgroundColor: value.trim() ? colors.accent : colors.borderLight, display: 'flex', alignItems: 'center', justifyContent: 'center', cursor: 'pointer'}
            }, e(Icons.Send, {size: 16, color: value.trim() ? '#fff' : colors.textMuted}))
          )
        );
      }

      function ResponseHeader(props) {
        var persona = props.persona;
        var showReasoning = props.showReasoning;
        var onToggle = props.onToggle;
        var showMvp = props.showMvp;
        var colors = props.colors;
        var Icons = props.Icons;
        
        var reasoning = {
          maya: {
            short: 'Visual learner â†’ Interactive diagram',
            memory: 'Prefers diagrams, infographics, and visual explanations. Learns best when information is color-coded and spatially organized.',
            rule: 'if (user.learningStyle === "visual") {\n  response.format = "interactive-diagram";\n  response.features = ["color-coding", "hover-states"];\n}'
          },
          james: {
            short: 'Deep reader â†’ Structured prose',
            memory: 'Prefers comprehensive written explanations with proper structure. Values depth, nuance, and being able to explore terminology.',
            rule: 'if (user.learningStyle === "reading") {\n  response.format = "structured-prose";\n  response.features = ["glossary", "sections"];\n}'
          },
          alex: {
            short: 'Hands-on â†’ Step-by-step tutorial',
            memory: 'Learns by doing. Prefers interactive tutorials where they can experiment and see immediate results.',
            rule: 'if (user.learningStyle === "kinesthetic") {\n  response.format = "interactive-tutorial";\n  response.features = ["live-input", "progress"];\n}'
          }
        };
        var r = reasoning[persona];
        
        return e('div', {style: {marginBottom: 16}},
          e('div', {style: {display: 'flex', alignItems: 'center', gap: 8, marginBottom: showReasoning ? 12 : 0, flexWrap: 'wrap'}},
            e('span', {style: {fontSize: 12, fontWeight: 500, color: colors.textSecondary}}, 'Claude'),
            e('button', {
              'data-tour': 'why-format',
              onClick: onToggle,
              style: {display: 'flex', alignItems: 'center', gap: 4, padding: '3px 8px', backgroundColor: showReasoning ? colors.purple + '15' : 'transparent', border: '1px solid ' + (showReasoning ? colors.purple : colors.borderLight), borderRadius: 12, cursor: 'pointer', fontFamily: 'inherit', fontSize: 11, color: showReasoning ? colors.purple : colors.textMuted}
            },
              e(Icons.Info, {size: 12}), ' Why this format?', showReasoning ? e(Icons.ChevronDown, {size: 12}) : e(Icons.ChevronRight, {size: 12})
            ),
            !showReasoning && e('span', {style: {fontSize: 11, color: colors.textMuted, fontStyle: 'italic'}}, r.short),
            showMvp && !showReasoning && e(FeasibilityBadge, {level: 'now', colors: colors})
          ),
          showReasoning && e('div', {style: {backgroundColor: colors.bgSidebar, borderRadius: 12, padding: 16, border: '1px solid ' + colors.borderLight}},
            e('div', {style: {marginBottom: 14}},
              e('div', {style: {display: 'flex', alignItems: 'center', gap: 6, marginBottom: 6}},
                e('div', {style: {width: 6, height: 6, borderRadius: '50%', backgroundColor: colors.accent}}),
                e('span', {style: {fontSize: 11, fontWeight: 600, color: colors.textSecondary, textTransform: 'uppercase', letterSpacing: 0.5}}, "Claude's Memory"),
                showMvp && e(FeasibilityBadge, {level: 'now', colors: colors})
              ),
              e('p', {style: {margin: 0, fontSize: 13, color: colors.textPrimary, lineHeight: 1.5, paddingLeft: 12}}, r.memory)
            ),
            e('div', null,
              e('div', {style: {display: 'flex', alignItems: 'center', gap: 6, marginBottom: 6}},
                e('div', {style: {width: 6, height: 6, borderRadius: '50%', backgroundColor: colors.purple}}),
                e('span', {style: {fontSize: 11, fontWeight: 600, color: colors.textSecondary, textTransform: 'uppercase', letterSpacing: 0.5}}, 'UI Constitution Rule'),
                showMvp && e(FeasibilityBadge, {level: 'now', colors: colors})
              ),
              e('pre', {style: {margin: 0, fontSize: 11, color: '#E8E6E1', backgroundColor: '#2D2D2D', padding: 12, borderRadius: 8, overflow: 'auto', lineHeight: 1.5}}, r.rule)
            )
          )
        );
      }

      function MayaResponse(props) {
        var onFollowUp = props.onFollowUp;
        var showMvp = props.showMvp;
        var colors = props.colors;
        var Icons = props.Icons;
        
        var _s = useState(null);
        var active = _s[0];
        var setActive = _s[1];
        
        var stages = [
          {id: 'input', label: 'Input', color: colors.blue, short: 'Text arrives as characters', icon: Icons.MessageBubble},
          {id: 'tokenize', label: 'Tokenize', color: colors.purple, short: 'Text splits into tokens', icon: Icons.TextSplit},
          {id: 'embed', label: 'Embed', color: colors.purple, short: 'Tokens become vectors', icon: Icons.Network},
          {id: 'attention', label: 'Attention', color: colors.purple, short: '96 layers learn relationships', icon: Icons.Grid},
          {id: 'output', label: 'Output', color: colors.green, short: 'Model predicts next token', icon: Icons.Chart}
        ];

        return e('div', null,
          e('div', {style: {display: 'flex', alignItems: 'center', gap: 8, marginBottom: 12}},
            e('p', {style: {margin: 0, color: colors.textSecondary}}, "Here's how your words flow through an LLM â€” tap any stage:"),
            showMvp && e(FeasibilityBadge, {level: 'near', colors: colors})
          ),
          e('div', {style: {background: colors.bgSidebar, borderRadius: 16, border: '1px solid ' + colors.borderLight, padding: 20, marginBottom: 16}},
            e('div', {style: {display: 'flex', flexDirection: 'column', gap: 6}},
              stages.map(function(stage, i) {
                return e(React.Fragment, {key: stage.id},
                  e('div', {
                    onClick: function() { setActive(active === stage.id ? null : stage.id); },
                    style: {width: '100%', padding: '12px 14px', background: stage.color + '15', border: '2px solid ' + (active === stage.id ? stage.color : stage.color + '40'), borderRadius: 12, cursor: 'pointer'}
                  },
                    e('div', {style: {display: 'flex', alignItems: 'center', gap: 10}},
                      e('div', {style: {width: 36, height: 36, borderRadius: 10, background: stage.color, display: 'flex', alignItems: 'center', justifyContent: 'center'}},
                        e(stage.icon)
                      ),
                      e('div', null,
                        e('div', {style: {fontSize: 12, fontWeight: 600, color: stage.color, textTransform: 'uppercase'}}, stage.label),
                        e('div', {style: {fontSize: 12, color: colors.textSecondary}}, stage.short)
                      )
                    )
                  ),
                  i < stages.length - 1 && e('div', {style: {display: 'flex', justifyContent: 'center'}},
                    e('div', {style: {width: 2, height: 12, background: colors.borderMedium}})
                  )
                );
              })
            )
          ),
          e(Beacons, {drillDown: ['Attention deep-dive'], sideways: ['Compare to human cognition'], colors: colors, Icons: Icons, onSelect: onFollowUp})
        );
      }

      function JamesResponse(props) {
        var onFollowUp = props.onFollowUp;
        var showMvp = props.showMvp;
        var colors = props.colors;
        var Icons = props.Icons;

        return e('div', null,
          e('p', {style: {marginBottom: 16, color: colors.textPrimary, lineHeight: 1.8}},
            'Large Language Models represent a fundamental shift in AI. Rather than programming explicit rules, we train neural networks on vast text corpora to predict and generate language.'
          ),
          e('div', {style: {display: 'flex', alignItems: 'center', gap: 8, marginBottom: 12}},
            e('span', {style: {color: colors.accent, fontSize: 12, fontWeight: 600}}, 'ðŸ’¡ Click underlined terms to explore'),
            showMvp && e(FeasibilityBadge, {level: 'near', colors: colors})
          ),
          e('h3', {style: {fontSize: 14, fontWeight: 600, color: colors.textPrimary, marginBottom: 8, marginTop: 20}}, '1. The Core Architecture'),
          e('p', {style: {marginBottom: 16, color: colors.textPrimary, lineHeight: 1.8}},
            'Modern LLMs use the transformer architecture with attention mechanisms to process all tokens in parallel.'
          ),
          e('div', {style: {borderLeft: '3px solid ' + colors.accent, backgroundColor: colors.accent + '10', padding: '14px 18px', borderRadius: '0 8px 8px 0', marginBottom: 16}},
            e('p', {style: {margin: 0, fontStyle: 'italic', color: colors.textSecondary}},
              e('strong', {style: {color: colors.textPrimary}}, 'Key insight: '),
              "LLMs are pattern matchers that predict likely continuations based on statistical patterns."
            )
          ),
          e(Beacons, {drillDown: ['Explain attention'], sideways: ["What can't LLMs do?"], colors: colors, Icons: Icons, onSelect: onFollowUp})
        );
      }

      function AlexResponse(props) {
        var onFollowUp = props.onFollowUp;
        var showMvp = props.showMvp;
        var colors = props.colors;
        var Icons = props.Icons;
        
        var _s1 = useState('');
        var input = _s1[0];
        var setInput = _s1[1];
        
        var _s2 = useState(1);
        var step = _s2[0];
        var setStep = _s2[1];
        
        var _s3 = useState([]);
        var completed = _s3[0];
        var setCompleted = _s3[1];
        
        var tokens = input ? input.split(/\s+/).filter(function(x) { return x; }) : ['Hello', 'world!'];
        var steps = [{n: 1, t: 'Input'}, {n: 2, t: 'Tokenize'}, {n: 3, t: 'Process'}, {n: 4, t: 'Output'}];
        
        function next() {
          if (step < 4) { setCompleted(completed.concat([step])); setStep(step + 1); }
        }

        return e('div', null,
          e('div', {style: {display: 'flex', alignItems: 'center', gap: 8, marginBottom: 16}},
            e('p', {style: {margin: 0, color: colors.textPrimary}}, "Let's learn by doing. Complete each step."),
            showMvp && e(FeasibilityBadge, {level: 'near', colors: colors})
          ),
          e('div', {style: {display: 'flex', alignItems: 'center', gap: 4, marginBottom: 16}},
            steps.map(function(s, i) {
              return e(React.Fragment, {key: s.n},
                e('div', {style: {width: 24, height: 24, borderRadius: '50%', background: completed.indexOf(s.n) > -1 ? colors.green : step === s.n ? colors.accent : colors.borderLight, color: '#fff', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: 11, fontWeight: 600}},
                  completed.indexOf(s.n) > -1 ? 'âœ“' : s.n
                ),
                i < 3 && e('div', {style: {width: 20, height: 2, background: completed.indexOf(s.n) > -1 ? colors.green : colors.borderLight}})
              );
            })
          ),
          e('div', {style: {backgroundColor: colors.cardBg, borderRadius: 12, border: '1px solid ' + colors.borderLight, padding: 16, marginBottom: 12}},
            step === 1 && e('div', null,
              e('h4', {style: {margin: '0 0 8px', fontSize: 14, color: colors.textPrimary}}, 'Step 1: Enter Text'),
              e('input', {type: 'text', value: input, onChange: function(ev) { setInput(ev.target.value); }, placeholder: 'Hello world!', style: {width: '100%', padding: 10, fontSize: 14, border: '1px solid ' + colors.borderLight, borderRadius: 8, backgroundColor: colors.bgPrimary, color: colors.textPrimary, boxSizing: 'border-box'}})
            ),
            step === 2 && e('div', null,
              e('h4', {style: {margin: '0 0 8px', fontSize: 14, color: colors.textPrimary}}, 'Step 2: Tokenization'),
              e('div', {style: {display: 'flex', gap: 6, flexWrap: 'wrap'}},
                tokens.map(function(t, i) {
                  return e('span', {key: i, style: {padding: '4px 10px', backgroundColor: colors.purple + '20', color: colors.purple, borderRadius: 6, fontSize: 12}}, t);
                })
              )
            ),
            step === 3 && e('div', null,
              e('h4', {style: {margin: '0 0 8px', fontSize: 14, color: colors.textPrimary}}, 'Step 3: Processing'),
              e('p', {style: {color: colors.textSecondary, fontSize: 13}}, '96 attention layers analyzing...')
            ),
            step === 4 && e('div', null,
              e('h4', {style: {margin: '0 0 8px', fontSize: 14, color: colors.textPrimary}}, 'Step 4: Prediction'),
              e('div', {style: {padding: 12, background: colors.green + '15', borderRadius: 8}},
                [{w: 'world', p: 23}, {w: 'there', p: 18}].map(function(x, i) {
                  return e('div', {key: i, style: {display: 'flex', alignItems: 'center', gap: 8, marginTop: i ? 6 : 0}},
                    e('span', {style: {fontSize: 12, width: 50, color: colors.textPrimary}}, x.w),
                    e('div', {style: {flex: 1, height: 6, background: colors.green + '30', borderRadius: 3}},
                      e('div', {style: {width: x.p * 2.5 + '%', height: '100%', background: colors.green, borderRadius: 3}})
                    )
                  );
                })
              )
            )
          ),
          e('button', {
            onClick: next,
            disabled: step === 1 && !input.trim(),
            style: {padding: '10px 20px', borderRadius: 8, border: 'none', background: (step === 1 && !input.trim()) ? colors.borderLight : colors.accent, color: '#fff', cursor: 'pointer', fontFamily: 'inherit'}
          }, step === 4 ? 'Complete!' : 'Next â†’'),
          e(Beacons, {drillDown: ['Build a transformer'], colors: colors, Icons: Icons, onSelect: onFollowUp})
        );
      }

      // MAIN APP
      function App() {
        var isDark = useSystemDarkMode();
        var colors = getColors(isDark);
        var Icons = getIcons(colors);
        
        var _s1 = useState('maya');
        var persona = _s1[0];
        var setPersona = _s1[1];
        
        var _s2 = useState('welcome');
        var view = _s2[0];
        var setView = _s2[1];
        
        var _s3 = useState('');
        var message = _s3[0];
        var setMessage = _s3[1];
        
        var _s4 = useState('');
        var inputValue = _s4[0];
        var setInputValue = _s4[1];
        
        var _s5 = useState(false);
        var isLoading = _s5[0];
        var setIsLoading = _s5[1];
        
        var _s6 = useState(false);
        var showReasoning = _s6[0];
        var setShowReasoning = _s6[1];
        
        var _s7 = useState(false);
        var showMvp = _s7[0];
        var setShowMvp = _s7[1];
        
        var _s8 = useState(null);
        var formatOverride = _s8[0];
        var setFormatOverride = _s8[1];
        
        var _s9 = useState(true);
        var showTour = _s9[0];
        var setShowTour = _s9[1];
        
        var _s10 = useState(0);
        var tourStep = _s10[0];
        var setTourStep = _s10[1];

        var personas = [{id: 'maya', name: 'Maya', style: 'Visual'}, {id: 'james', name: 'James', style: 'Reading'}, {id: 'alex', name: 'Alex', style: 'Hands-On'}];
        
        function selectPrompt(text) {
          setMessage(text);
          setIsLoading(true);
          setView('chat');
          setFormatOverride(null);
          setTimeout(function() { setIsLoading(false); }, 1200);
        }
        
        function send(text) {
          setMessage(text);
          setInputValue('');
          setIsLoading(true);
          setView('chat');
          setTimeout(function() { setIsLoading(false); }, 1200);
        }
        
        function reset() {
          setView('welcome');
          setMessage('');
          setInputValue('');
          setShowReasoning(false);
          setFormatOverride(null);
        }

        var effectiveFormat = formatOverride || (persona === 'maya' ? 'visual' : persona === 'alex' ? 'interactive' : 'text');

        // Auto-advance to chat for tour steps that need it
        useEffect(function() {
          if (showTour && tourStep >= 3 && view === 'welcome') {
            selectPrompt('Explain how large language models work');
          }
        }, [tourStep, showTour]);

        return e('div', {style: {fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif', display: 'flex', height: '100vh', borderRadius: 12, overflow: 'hidden', border: '1px solid ' + colors.borderLight, boxShadow: '0 4px 24px rgba(0,0,0,0.08)', position: 'relative', backgroundColor: colors.bgPrimary}},
          
          // Tour
          showTour && e(SpotlightTour, {
            isLoading: isLoading,
            step: tourStep,
            colors: colors,
            Icons: Icons,
            onNext: function() { setTourStep(tourStep + 1); },
            onSkip: function() { setShowTour(false); },
            onComplete: function() { setShowTour(false); reset(); }
          }),
          
          showMvp && e('div', {onClick: function() { setShowMvp(false); }, style: {position: 'absolute', inset: 0, zIndex: 5, cursor: 'pointer'}}),
          
          // Sidebar
          e('div', {style: {width: 260, flexShrink: 0, display: 'flex', flexDirection: 'column', borderRight: '1px solid ' + colors.borderLight, backgroundColor: colors.bgSidebar, zIndex: 10}},
            e('div', {style: {padding: '14px 18px', display: 'flex', alignItems: 'center', gap: 8, borderBottom: '1px solid ' + colors.borderLight}},
              e(Icons.Claude, {size: 22}),
              e('span', {style: {fontSize: 17, fontWeight: 600, color: colors.textPrimary}}, 'Claude')
            ),
            e('div', {style: {padding: '10px 14px'}},
              e('button', {onClick: reset, style: {width: '100%', padding: '9px 14px', backgroundColor: colors.bgPrimary, border: '1px solid ' + colors.borderLight, borderRadius: 8, display: 'flex', alignItems: 'center', gap: 7, cursor: 'pointer', fontSize: 13, color: colors.textPrimary, fontFamily: 'inherit'}},
                e(Icons.Plus, {size: 15}), 'New chat'
              )
            ),
            e('div', {style: {flex: 1}}),
            
            // Demo Controls
            e('div', {
              'data-tour': 'persona-switcher',
              style: {margin: 14, padding: 14, backgroundColor: colors.bgPrimary, borderRadius: 10, border: '1px solid ' + colors.borderLight}
            },
              e('div', {style: {display: 'flex', alignItems: 'center', gap: 7, marginBottom: 10}},
                e(Icons.Zap, {size: 16, color: colors.accent}),
                e('span', {style: {fontSize: 12, fontWeight: 600, color: colors.textPrimary}}, 'Demo Mode')
              ),
              e('button', {
                'data-tour': 'feasibility-toggle',
                onClick: function() { setShowMvp(!showMvp); },
                style: {width: '100%', padding: '8px 10px', marginBottom: 10, backgroundColor: showMvp ? colors.blue + '20' : 'transparent', border: '1px solid ' + (showMvp ? colors.blue : colors.borderLight), borderRadius: 6, cursor: 'pointer', fontSize: 11, color: showMvp ? colors.blue : colors.textSecondary, fontFamily: 'inherit', display: 'flex', alignItems: 'center', gap: 6}
              }, e(Icons.Layers, {size: 12}), (showMvp ? 'Hide' : 'Show') + ' feasibility'),
              e('div', {style: {fontSize: 11, color: colors.textSecondary, marginBottom: 8}}, 'Switch persona:'),
              e('div', {style: {display: 'flex', flexDirection: 'column', gap: 3}},
                personas.map(function(p) {
                  return e('button', {
                    key: p.id,
                    onClick: function() { setPersona(p.id); setFormatOverride(null); },
                    style: {display: 'flex', alignItems: 'center', gap: 9, padding: '9px 10px', borderRadius: 7, border: 'none', backgroundColor: persona === p.id ? colors.accent + '20' : 'transparent', cursor: 'pointer', width: '100%', textAlign: 'left', fontFamily: 'inherit'}
                  },
                    e('div', {style: {width: 7, height: 7, borderRadius: '50%', border: '2px solid ' + (persona === p.id ? colors.accent : colors.borderMedium), backgroundColor: persona === p.id ? colors.accent : 'transparent'}}),
                    e('div', null,
                      e('div', {style: {fontSize: 12, fontWeight: persona === p.id ? 600 : 400, color: persona === p.id ? colors.accent : colors.textPrimary}}, p.name),
                      e('div', {style: {fontSize: 10, color: colors.textMuted}}, p.style)
                    )
                  );
                })
              )
            ),
            
            showMvp && e('div', {style: {margin: '0 14px 14px', padding: 12, backgroundColor: colors.cardBg, borderRadius: 8, border: '1px solid ' + colors.borderLight}},
              e('div', {style: {fontSize: 10, fontWeight: 600, color: colors.textMuted, marginBottom: 8, textTransform: 'uppercase'}}, 'Phases'),
              [{l: 'now', t: 'Memory + prompts'}, {l: 'near', t: 'Artifacts + UI'}, {l: 'future', t: 'New infra'}].map(function(x) {
                return e('div', {key: x.l, style: {display: 'flex', alignItems: 'center', gap: 6, marginBottom: 4}},
                  e(FeasibilityBadge, {level: x.l, glow: false, colors: colors}),
                  e('span', {style: {fontSize: 10, color: colors.textSecondary}}, x.t)
                );
              })
            ),
            
            // Tour button at bottom of sidebar
            !showTour && e('div', {style: {padding: '0 14px 14px'}},
              e(TourButton, {
                onClick: function() { setShowTour(true); setTourStep(0); },
                colors: colors,
                Icons: Icons
              })
            )
          ),

          // Main content
          e('div', {style: {flex: 1, display: 'flex', flexDirection: 'column', backgroundColor: colors.bgPrimary, position: 'relative', zIndex: showMvp ? 6 : 1}},
            showMvp && e('div', {style: {position: 'absolute', inset: 0, backgroundColor: isDark ? 'rgba(0,0,0,0.5)' : 'rgba(255,255,255,0.6)', zIndex: 8, pointerEvents: 'none'}}),
            
            view === 'welcome' ? e(React.Fragment, null,
              e('div', {style: {flex: 1, display: 'flex', alignItems: 'center', justifyContent: 'center'}},
                e(WelcomeScreen, {onSelectPrompt: selectPrompt, persona: persona, colors: colors, Icons: Icons})
              ),
              e(InputBar, {persona: persona, onSend: send, value: inputValue, setValue: setInputValue, colors: colors, Icons: Icons})
            ) : e(React.Fragment, null,
              e('div', {style: {flex: 1, overflow: 'auto', padding: '16px 24px'}},
                e('div', {style: {display: 'flex', justifyContent: 'flex-end', marginBottom: 20}},
                  e('div', {style: {maxWidth: '85%', backgroundColor: colors.userBubble, padding: '10px 14px', borderRadius: 14, fontSize: 13, color: colors.textPrimary}}, message)
                ),
                isLoading ? e('div', {style: {display: 'flex', gap: 10}},
                  e('div', {style: {width: 24, height: 24, borderRadius: '50%', backgroundColor: colors.accent + '20', display: 'flex', alignItems: 'center', justifyContent: 'center'}}, e(Icons.Claude, {size: 12})),
                  e('div', {style: {padding: 12, backgroundColor: colors.bgSidebar, borderRadius: 10}},
                    e('span', {style: {fontSize: 12, color: colors.accent}}, 'Thinking...')
                  )
                ) : e('div', {style: {display: 'flex', gap: 10}},
                  e('div', {style: {width: 24, height: 24, borderRadius: '50%', backgroundColor: colors.accent + '20', display: 'flex', alignItems: 'center', justifyContent: 'center', flexShrink: 0}}, e(Icons.Claude, {size: 12})),
                  e('div', {style: {flex: 1, minWidth: 0}},
                    e(ResponseHeader, {persona: persona, showReasoning: showReasoning, onToggle: function() { setShowReasoning(!showReasoning); }, showMvp: showMvp, colors: colors, Icons: Icons}),
                    
                    e('div', {
                      'data-tour': 'format-switcher',
                      style: {display: 'flex', alignItems: 'center', gap: 8, marginBottom: 12, flexWrap: 'wrap'}
                    },
                      e('span', {style: {fontSize: 11, color: colors.textMuted}}, 'Format:'),
                      [{id: 'visual', label: 'Visual', icon: e(Icons.Image, {size: 10})}, {id: 'text', label: 'Text', icon: e(Icons.FileText, {size: 10})}, {id: 'interactive', label: 'Interactive', icon: e(Icons.Code, {size: 10})}].map(function(f) {
                        return e('button', {
                          key: f.id,
                          onClick: function() { setFormatOverride(f.id === effectiveFormat && formatOverride ? null : f.id); },
                          style: {display: 'flex', alignItems: 'center', gap: 4, padding: '4px 10px', fontSize: 11, border: '1px solid ' + (effectiveFormat === f.id ? colors.accent : colors.borderLight), borderRadius: 12, backgroundColor: effectiveFormat === f.id ? colors.accent + '15' : colors.cardBg, color: effectiveFormat === f.id ? colors.accent : colors.textSecondary, cursor: 'pointer', fontFamily: 'inherit'}
                        }, f.icon, ' ', f.label, effectiveFormat === f.id && !formatOverride ? e('span', {style: {fontSize: 9, opacity: 0.7}}, ' (auto)') : null);
                      }),
                      showMvp && e(FeasibilityBadge, {level: 'now', colors: colors})
                    ),
                    
                    e('div', {style: {fontSize: 14, lineHeight: 1.7, color: colors.textPrimary}},
                      effectiveFormat === 'visual' && e(MayaResponse, {onFollowUp: function(t) { setInputValue(t); }, showMvp: showMvp, colors: colors, Icons: Icons}),
                      effectiveFormat === 'text' && e(JamesResponse, {onFollowUp: function(t) { setInputValue(t); }, showMvp: showMvp, colors: colors, Icons: Icons}),
                      effectiveFormat === 'interactive' && e(AlexResponse, {onFollowUp: function(t) { setInputValue(t); }, showMvp: showMvp, colors: colors, Icons: Icons})
                    )
                  )
                )
              ),
              e(InputBar, {persona: persona, onSend: send, value: inputValue, setValue: setInputValue, colors: colors, Icons: Icons})
            )
          )
        );
      }

      ReactDOM.render(e(App), document.getElementById('root'));
    }
    
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initApp);
    } else {
      initApp();
    }
  </script>
</body>
</html>
